# aitestframework

AI芯片验证测试框架，覆盖NPU/GPU算子验证、AI模型推理测试及CPU预处理测试。

## 项目定位

为AI芯片验证团队提供一站式测试基础设施，包括：

- **桩代码管理** — C/C++激励源码的版本化管理与构建
- **Golden数据维护** — 基准数据的存储、版本管理与分发
- **版本构建管理** — 桩代码编译、工具链与第三方库的统一依赖管理
- **用例管理** — 算子级/模型级用例的注册、Golden关联、执行状态跟踪与报告
- **日志分析工具** — 测试执行日志与仿真器/硬件日志的解析与分析
- **自动化执行框架** — 支持本地与远程服务器(SSH)的用例调度与执行
- **CI Dashboard** — Flask多页签Web界面，集成CI流水线的可视化展示

## 技术栈

| 层级 | 技术 |
|------|------|
| 桩代码 | C/C++ |
| 工具层 | Python 3.10+ |
| Web | Flask + Jinja2 + 轻量前端 |
| 数据存储 | SQLite（本地） / 文件系统 |
| 远程执行 | SSH (paramiko) |
| CI集成 | webhook / API |

## 目录结构

```
aitestframework/
├── stubs/                          # 桩代码框架（C，编译为 .so）
│   ├── CMakeLists.txt              # 顶层构建配置
│   ├── build.sh                    # 一键构建脚本
│   ├── hooks/                      # 平台钩子（仅 typedef + 注册接口）
│   │   └── func_sim/
│   │       └── include/
│   │           ├── platform_api.h  # 钩子函数指针类型 + platform_register()
│   │           └── msg_types.h     # 消息类型定义
│   ├── common/                     # 公共控制层
│   │   ├── include/
│   │   │   ├── stub_registry.h     # 模型注册表接口
│   │   │   ├── stub_config.h       # 命令行参数解析
│   │   │   └── stub_log.h          # 日志宏
│   │   └── src/
│   │       ├── stub_main.c         # stub_entry() / stub_exit() 入口
│   │       ├── stub_platform.c     # platform_register() + 钩子包装函数
│   │       ├── stub_registry.c     # 注册表实现
│   │       └── stub_config.c       # 参数解析实现
│   ├── models/                     # 模型桩代码
│   │   ├── CMakeLists.txt          # 自动发现模型 + 生成注册表
│   │   ├── stub_model_table.c.in   # 注册表模板（CMake configure_file）
│   │   ├── tdd/                    # TDD 模型桩
│   │   │   ├── CMakeLists.txt
│   │   │   └── tdd_stub.c
│   │   └── fdd/                    # FDD 模型桩
│   │       ├── CMakeLists.txt
│   │       └── fdd_stub.c
│   ├── tests/                      # 单元测试
│   │   ├── CMakeLists.txt
│   │   ├── test_common.h           # 轻量测试宏（无外部依赖）
│   │   ├── test_registry.c
│   │   ├── test_platform.c
│   │   ├── test_tdd.c
│   │   ├── test_fdd.c
│   │   ├── platform_sim.c          # func_sim 平台模拟（仅测试用）
│   │   └── func_sim_main.c         # 测试入口 main()
│   └── tools/                      # 构建辅助脚本
│       ├── swap_endian.py          # 大小端转换
│       ├── pad_align.py            # 补零对齐
│       └── print_info.py           # 二进制信息打印
├── golden/                         # Golden 数据管理（规划）
├── cases/                          # 用例管理（规划）
├── runner/                         # 自动化执行框架（规划）
├── logparser/                      # 日志分析工具（规划）
├── web/                            # Flask Dashboard（规划）
├── docs/                           # 文档
│   └── req/                        # 需求文档
└── tests/                          # 框架自身的单元测试（规划）
```

---

## 需求分解

### REQ-1 桩代码管理

管理发送给仿真器/FPGA的C/C++激励代码。

| ID | 需求 | 优先级 |
|----|------|--------|
| REQ-1.1 | 桩代码按平台(npu/gpu/cpu)分目录组织 | P0 |
| REQ-1.2 | 桩代码版本与git tag关联，支持按版本检出 | P0 |
| REQ-1.3 | 提供桩代码编译脚本，支持指定目标平台和工具链 | P0 |
| REQ-1.4 | 桩代码变更时自动触发相关用例的重新执行 | P1 |
| REQ-1.5 | 支持桩代码模板，快速创建新算子/模型的激励代码 | P2 |

### REQ-2 Golden数据维护

管理算子/模型的基准参考数据。

| ID | 需求 | 优先级 |
|----|------|--------|
| REQ-2.1 | Golden数据注册表：记录每份数据的算子名、数据类型、shape、来源、版本 | P0 |
| REQ-2.2 | 支持本地文件系统存储Golden数据 | P0 |
| REQ-2.3 | 支持从远程服务器拉取/推送Golden数据（rsync/scp） | P0 |
| REQ-2.4 | Golden数据版本管理，支持回退到历史版本 | P1 |
| REQ-2.5 | Golden数据完整性校验（checksum） | P1 |
| REQ-2.6 | 支持多种数据格式：raw binary、numpy、自定义量化格式 | P1 |

### REQ-3 版本构建管理

统一管理桩代码编译、工具链和第三方库依赖。

| ID | 需求 | 优先级 |
|----|------|--------|
| REQ-3.1 | 工具链配置文件（YAML），声明编译器、仿真器等工具的版本和下载地址 | P0 |
| REQ-3.2 | 工具链自动下载与缓存，避免重复下载 | P0 |
| REQ-3.3 | 第三方C/C++库依赖声明与自动获取 | P0 |
| REQ-3.4 | Python依赖通过requirements.txt/pyproject.toml管理 | P0 |
| REQ-3.5 | 构建产物目录隔离，支持多平台并行构建 | P1 |
| REQ-3.6 | 构建缓存，增量编译支持 | P2 |

### REQ-4 用例管理

管理算子级和模型级测试用例的完整生命周期。

| ID | 需求 | 优先级 |
|----|------|--------|
| REQ-4.1 | 用例注册：名称、类型(算子/模型)、平台、关联桩代码、关联Golden | P0 |
| REQ-4.2 | 用例与Golden数据的绑定关系管理 | P0 |
| REQ-4.3 | 用例执行状态跟踪：PASS / FAIL / TIMEOUT / CRASH / SKIP / PENDING | P0 |
| REQ-4.4 | 执行报告生成：JSON格式结果 + 可读的HTML/终端报告 | P0 |
| REQ-4.5 | 用例筛选：按名称、标签、平台、状态过滤 | P1 |
| REQ-4.6 | 用例历史执行记录，支持趋势查看 | P1 |
| REQ-4.7 | 结果比较：精确匹配 + 模糊匹配（容差/相对误差/cosine相似度） | P1 |

### REQ-5 日志分析工具

解析测试框架日志和仿真器/硬件日志。

| ID | 需求 | 优先级 |
|----|------|--------|
| REQ-5.1 | 测试框架日志解析：提取用例执行结果、耗时、失败原因 | P0 |
| REQ-5.2 | 仿真器日志解析：提取关键事件、错误信息、性能数据 | P0 |
| REQ-5.3 | 硬件日志解析：提取寄存器状态、中断信息、DMA传输状态 | P1 |
| REQ-5.4 | 可配置的日志解析规则（正则/模式匹配），支持新增日志格式 | P1 |
| REQ-5.5 | 日志关键错误自动摘要与告警 | P2 |

### REQ-6 自动化执行框架

支持本地和远程服务器的测试调度与执行。

| ID | 需求 | 优先级 |
|----|------|--------|
| REQ-6.1 | 本地执行器：在本机编译并运行测试 | P0 |
| REQ-6.2 | 远程执行器：通过SSH连接远程服务器，传输文件并执行测试 | P0 |
| REQ-6.3 | 执行配置文件：定义目标机器、认证方式、工作目录 | P0 |
| REQ-6.4 | 串行/并行执行策略，支持用例分片 | P1 |
| REQ-6.5 | 超时控制与异常恢复（用例崩溃后继续执行下一个） | P1 |
| REQ-6.6 | 执行结果自动收集与回传 | P0 |
| REQ-6.7 | 支持CI触发（命令行接口 + webhook） | P1 |

### REQ-7 Flask CI Dashboard

多页签Web界面，可视化展示测试全流程状态。

| ID | 需求 | 优先级 |
|----|------|--------|
| REQ-7.1 | **概览页**：总体通过率、最近构建状态、失败用例Top N | P0 |
| REQ-7.2 | **用例管理页**：用例列表、筛选、状态、关联Golden查看 | P0 |
| REQ-7.3 | **执行记录页**：历史执行列表、详情、日志查看 | P0 |
| REQ-7.4 | **Golden管理页**：数据注册表浏览、版本、校验状态 | P1 |
| REQ-7.5 | **日志分析页**：日志上传/选择、解析结果展示、错误高亮 | P1 |
| REQ-7.6 | **构建管理页**：工具链状态、依赖版本、构建历史 | P1 |
| REQ-7.7 | **趋势图表**：通过率趋势、执行耗时趋势（Chart.js / ECharts） | P1 |
| REQ-7.8 | CI webhook接口：接收CI流水线推送的构建/测试结果 | P0 |
| REQ-7.9 | 简洁响应式布局，无需用户认证 | P0 |

### REQ-8 Jenkins CI 集成

Jenkins 流水线定义与自动化触发，覆盖桩代码构建验证和冒烟测试。

| ID | 需求 | 优先级 |
|----|------|--------|
| REQ-8.1 | **Stubs 构建 Pipeline**：Jenkinsfile 声明式 Pipeline，调用 `build.sh` 完成编译、UT、产物归档 | P0 |
| REQ-8.2 | **事件触发**：stubs/ 目录下代码提交时自动触发构建 + UT（Git webhook / SCM polling） | P0 |
| REQ-8.3 | **每日冒烟**：每天定时（cron）使用"最新"依赖套配置，构建并执行全量冒烟用例 | P0 |
| REQ-8.4 | **手动冒烟**：手动触发，指定依赖套配置（工具链版本、第三方库版本等），执行冒烟用例回归 | P0 |
| REQ-8.5 | **冒烟用例**：冒烟测试用例通过 Python API 编写，Pipeline 调用 Python 测试入口执行 | P0 |
| REQ-8.6 | 参数化构建：支持选择平台、模型列表、构建模式、依赖套配置等参数 | P0 |
| REQ-8.7 | 产物管理：构建产物（.so、测试报告）自动归档与版本标记 | P0 |
| REQ-8.8 | 测试结果回传：Pipeline 执行完成后将结果推送至 Dashboard（REQ-7.8） | P1 |
| REQ-8.9 | 多节点支持：支持在不同 Jenkins agent 上执行不同平台的构建 | P1 |
| REQ-8.10 | 失败通知：构建/测试失败时通过邮件或即时通讯通知 | P2 |
| REQ-8.11 | **一键部署（Linux）**：提供 shell 脚本，自动安装 Jenkins + 依赖 + 创建 Job + 配置触发器 | P0 |
| REQ-8.12 | **一键部署（Windows）**：提供 PowerShell 脚本，自动安装 Jenkins + 依赖 + 创建 Job + 配置触发器 | P0 |

### 非功能需求

| ID | 需求 | 优先级 |
|----|------|--------|
| NFR-1 | 框架自身代码需有单元测试，覆盖率 > 80% | P1 |
| NFR-2 | Python代码风格遵循PEP8，使用ruff检查 | P0 |
| NFR-3 | 关键模块需有docstring和类型注解 | P1 |
| NFR-4 | 支持Python 3.10+ | P0 |
| NFR-5 | Web页面响应时间 < 2s | P1 |
| NFR-6 | 支持SQLite存储，无需额外数据库服务 | P0 |

---

## 模块依赖关系

```
              ┌──────────┐
              │ Jenkins  │  REQ-8
              │   CI     │
              └────┬─────┘
                   │ 触发 / 回传
          ┌────────┴────────┐
          ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │ 自动化   │      │   Web    │  REQ-7
    │ 执行框架 │      │Dashboard │
    │  REQ-6   │      └────┬─────┘
    └────┬─────┘           │ 读取
         │       ┌─────────┼──────────┐
         │       ▼         ▼          ▼
         │ ┌──────────┐┌────────┐┌────────┐
         │ │   用例   ││  日志  ││  构建  │
         │ │   管理   ││  分析  ││  管理  │
         │ │  REQ-4   ││ REQ-5  ││ REQ-3  │
         │ └────┬─────┘└────────┘└───┬────┘
         │      │                    │
    ┌────┴──┐   │              ┌─────┴───┐
    ▼       ▼   ▼              ▼         ▼
┌───────┐┌────────┐     ┌────────┐┌────────┐
│  桩   ││ Golden │     │ 工具链 ││  桩    │
│ 代码  ││  数据  │     │  依赖  ││ 代码   │
│ REQ-1 ││ REQ-2  │     │ REQ-3  ││ REQ-1  │
└───────┘└────────┘     └────────┘└────────┘
```

## 开发路线

**Phase 1 (基础):** REQ-1, REQ-2, REQ-3 核心功能 — 桩代码、Golden、构建能跑通

**Phase 2 (执行):** REQ-4, REQ-6 核心功能 — 用例管理和自动化执行跑通

**Phase 3 (可视化):** REQ-5, REQ-7 核心功能 — 日志分析和Dashboard基本可用

**Phase 4 (CI):** REQ-8 核心功能 — Jenkins Pipeline 定义、触发策略、产物归档、结果回传

**Phase 5 (完善):** 所有P1/P2需求 — 趋势分析、高级筛选、缓存优化、失败通知等
