# GC 嵌入比对系统架构设计文档

> 版本: 1.0
> 日期: 2024-01
> 状态: Draft

---

## 目录

1. [概述](#1-概述)
2. [场景视图 (Scenarios)](#2-场景视图-scenarios)
3. [逻辑视图 (Logical View)](#3-逻辑视图-logical-view)
4. [进程视图 (Process View)](#4-进程视图-process-view)
5. [开发视图 (Development View)](#5-开发视图-development-view)
6. [物理视图 (Physical View)](#6-物理视图-physical-view)
7. [数据设计](#7-数据设计)
8. [接口设计](#8-接口设计)
9. [附录](#9-附录)

---

## 1. 概述

### 1.1 目的

本文档描述 GC (Golden Comparison) 嵌入比对系统的软件架构设计。该系统用于在功能仿真过程中对 DUT (Device Under Test) 输出进行实时精度验证，确保硬件实现与软件 Golden 的一致性。

### 1.2 范围

- 双前端支持 (Python / C)
- 双编译器集成 (py2c / c2dut)
- 功能仿真器 GC 嵌入
- 三级比对机制 (单步/片段/全模型)
- Golden 生成与验证
- 比对报告生成

### 1.3 术语定义

| 术语 | 定义 |
|------|------|
| DUT | Device Under Test，被测硬件/仿真器输出 |
| Golden | 软件参考实现的正确输出 |
| GC | Golden Comparison，Golden 比对 |
| py2c | Python 到 C 代码转换器 |
| c2dut | C 代码到 DUT 二进制编译器 |
| BFP | Block Floating Point，块浮点格式 |
| QSNR | Quantization Signal-to-Noise Ratio，量化信噪比 |

### 1.4 设计目标

1. **正确性验证**: 确保 DUT 输出与 Golden 一致
2. **Golden 可信**: 验证 Golden 本身的正确性
3. **灵活性**: 支持单步、片段、全模型三级比对粒度
4. **可扩展**: 易于添加新的算子和比对指标
5. **易用性**: Python/C 双前端，统一 API

---

## 2. 场景视图 (Scenarios)

### 2.1 核心用例

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用例图                                          │
│                                                                             │
│                         ┌─────────────┐                                     │
│                         │   开发者     │                                     │
│                         └──────┬──────┘                                     │
│                                │                                            │
│         ┌──────────────────────┼──────────────────────┐                     │
│         │                      │                      │                     │
│         ▼                      ▼                      ▼                     │
│  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐               │
│  │ UC1: 编写   │       │ UC2: 编译   │       │ UC3: 仿真   │               │
│  │ 模型代码    │       │ 生成 DUT    │       │ 并比对      │               │
│  └─────────────┘       └─────────────┘       └─────────────┘               │
│         │                      │                      │                     │
│         │                      │                      │                     │
│         ▼                      ▼                      ▼                     │
│  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐               │
│  │ UC4: 生成   │       │ UC5: 管理   │       │ UC6: 查看   │               │
│  │ Golden      │       │ 工具链      │       │ 比对报告    │               │
│  └─────────────┘       └─────────────┘       └─────────────┘               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 用例详细描述

#### UC1: 编写模型代码

**参与者**: 开发者

**前置条件**: 无

**主流程**:
1. 开发者选择前端语言 (Python 或 C)
2. 使用统一 API 编写模型代码
3. 定义输入数据生成逻辑
4. 定义权重初始化逻辑
5. 定义算子调用序列
6. 标记检查点 (可选)

**后置条件**: 生成 model.py 或 model.c

#### UC2: 编译生成 DUT

**参与者**: 开发者

**前置条件**:
- 模型代码已编写
- 工具链已安装

**主流程**:
1. 系统检查工具链版本
2. [Python 路径] py2c 转换为 C 代码，同时生成 Golden
3. c2dut 编译 C 代码为 DUT 二进制
4. 输出 model.bin

**后置条件**: 生成 DUT 二进制和 Golden 数据

#### UC3: 仿真并比对

**参与者**: 开发者

**前置条件**:
- DUT 二进制已生成
- Golden 数据已生成

**主流程**:
1. 功能仿真器加载 DUT 二进制
2. 加载 Golden 数据
3. 执行仿真
4. 在检查点触发 GC 比对
5. 记录比对结果
6. 生成比对报告

**后置条件**: 生成比对报告

---

### 2.3 关键场景流程

#### 场景 1: Python 路径完整流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Python 路径序列图                                       │
│                                                                             │
│  开发者        py2c         c2dut       功能仿真器      比对引擎             │
│    │            │            │            │              │                  │
│    │ model.py   │            │            │              │                  │
│    │──────────→│            │            │              │                  │
│    │            │            │            │              │                  │
│    │            │ 执行+Trace │            │              │                  │
│    │            │──────┐     │            │              │                  │
│    │            │      │     │            │              │                  │
│    │            │←─────┘     │            │              │                  │
│    │            │            │            │              │                  │
│    │            │ model_gen.c│            │              │                  │
│    │            │──────────→│            │              │                  │
│    │            │            │            │              │                  │
│    │            │ golden/    │            │              │                  │
│    │←───────────│            │            │              │                  │
│    │            │            │            │              │                  │
│    │            │            │ 编译       │              │                  │
│    │            │            │──────┐     │              │                  │
│    │            │            │      │     │              │                  │
│    │            │            │←─────┘     │              │                  │
│    │            │            │            │              │                  │
│    │            │ model.bin  │            │              │                  │
│    │←───────────────────────│            │              │                  │
│    │            │            │            │              │                  │
│    │            │            │  加载+执行  │              │                  │
│    │────────────────────────────────────→│              │                  │
│    │            │            │            │              │                  │
│    │            │            │            │  GC 比对     │                  │
│    │            │            │            │─────────────→│                  │
│    │            │            │            │              │                  │
│    │            │            │            │  比对结果    │                  │
│    │            │            │            │←─────────────│                  │
│    │            │            │            │              │                  │
│    │               比对报告                │              │                  │
│    │←──────────────────────────────────────────────────│                  │
│    │            │            │            │              │                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 场景 2: C 路径完整流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        C 路径序列图                                          │
│                                                                             │
│  开发者     model_golden.py   c2dut     功能仿真器      比对引擎             │
│    │            │              │            │              │                │
│    │ 运行生成    │              │            │              │                │
│    │──────────→│              │            │              │                │
│    │            │              │            │              │                │
│    │ golden/    │              │            │              │                │
│    │←───────────│              │            │              │                │
│    │            │              │            │              │                │
│    │ model.c                   │            │              │                │
│    │─────────────────────────→│            │              │                │
│    │            │              │            │              │                │
│    │            │              │ 编译       │              │                │
│    │            │              │──────┐     │              │                │
│    │            │              │      │     │              │                │
│    │            │              │←─────┘     │              │                │
│    │            │              │            │              │                │
│    │ model.bin                 │            │              │                │
│    │←──────────────────────────│            │              │                │
│    │            │              │            │              │                │
│    │            │              │  加载+执行  │              │                │
│    │───────────────────────────────────────→│              │                │
│    │            │              │            │              │                │
│    │            │              │            │  GC 比对     │                │
│    │            │              │            │─────────────→│                │
│    │            │              │            │              │                │
│    │               比对报告                  │              │                │
│    │←─────────────────────────────────────────────────────│                │
│    │            │              │            │              │                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 逻辑视图 (Logical View)

### 3.1 系统分层架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           系统分层架构                                        │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         应用层 (Application)                           │ │
│  │                                                                       │ │
│  │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                │ │
│  │   │  CLI 命令   │   │  Python API │   │   C API     │                │ │
│  │   └─────────────┘   └─────────────┘   └─────────────┘                │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                    │                                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         前端层 (Frontend)                              │ │
│  │                                                                       │ │
│  │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                │ │
│  │   │ Unified API │   │   Trace     │   │  Compile    │                │ │
│  │   │ (统一接口)  │   │  (追踪器)   │   │  (编译封装) │                │ │
│  │   └─────────────┘   └─────────────┘   └─────────────┘                │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                    │                                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         核心层 (Core)                                  │ │
│  │                                                                       │ │
│  │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                │ │
│  │   │    Ops      │   │   Formats   │   │   Compare   │                │ │
│  │   │  (算子库)   │   │  (量化格式) │   │  (比对引擎) │                │ │
│  │   └─────────────┘   └─────────────┘   └─────────────┘                │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                    │                                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         基础设施层 (Infrastructure)                    │ │
│  │                                                                       │ │
│  │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                │ │
│  │   │  Toolchain  │   │    I/O      │   │   Config    │                │ │
│  │   │ (工具链管理)│   │ (文件读写)  │   │  (配置管理) │                │ │
│  │   └─────────────┘   └─────────────┘   └─────────────┘                │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                    │                                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         外部系统 (External)                            │ │
│  │                                                                       │ │
│  │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                │ │
│  │   │    py2c     │   │    c2dut    │   │  func-sim   │                │ │
│  │   │  (编译器)   │   │   (编译器)  │   │  (仿真器)   │                │ │
│  │   └─────────────┘   └─────────────┘   └─────────────┘                │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 核心类图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             核心类图                                         │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          Tensor                                      │   │
│  │  ─────────────────────────────────────────────────────────────────  │   │
│  │  + data: np.ndarray          # fp32 数据                            │   │
│  │  + quant_data: bytes         # 量化数据                             │   │
│  │  + shape: Tuple[int, ...]    # 形状                                 │   │
│  │  + dtype: str                # 数据类型                             │   │
│  │  + meta: dict                # 元信息                               │   │
│  │  ─────────────────────────────────────────────────────────────────  │   │
│  │  + quantize(qtype) -> Tensor                                        │   │
│  │  + dequantize() -> Tensor                                           │   │
│  │  + save(path)                                                       │   │
│  │  + load(path) -> Tensor                                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                    ┌───────────────┴───────────────┐                        │
│                    │                               │                        │
│                    ▼                               ▼                        │
│  ┌─────────────────────────────┐   ┌─────────────────────────────┐         │
│  │       DataGenerator         │   │        CompareEngine         │         │
│  │  ─────────────────────────  │   │  ───────────────────────────  │         │
│  │  + seed: int                │   │  + config: CompareConfig     │         │
│  │  ─────────────────────────  │   │  ───────────────────────────  │         │
│  │  + gen_input() -> Tensor    │   │  + compare() -> CompareResult│         │
│  │  + gen_weight() -> Tensor   │   │  + check_golden_sanity()     │         │
│  └─────────────────────────────┘   │  + generate_report()         │         │
│                                    └─────────────────────────────────┘         │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       ToolchainManager                               │   │
│  │  ─────────────────────────────────────────────────────────────────  │   │
│  │  + config: ToolchainConfig                                          │   │
│  │  + cache_dir: Path                                                  │   │
│  │  ─────────────────────────────────────────────────────────────────  │   │
│  │  + ensure(tool, version) -> str                                     │   │
│  │  + get_path(tool) -> str                                            │   │
│  │  + list_installed() -> dict                                         │   │
│  │  + clean(keep) -> list                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        CompareResult                                 │   │
│  │  ─────────────────────────────────────────────────────────────────  │   │
│  │  + exact_pass: bool                                                 │   │
│  │  + exact_max_abs: float                                             │   │
│  │  + fuzzy_pure_pass: bool                                            │   │
│  │  + fuzzy_pure_qsnr: float                                           │   │
│  │  + fuzzy_qnt_pass: bool                                             │   │
│  │  + fuzzy_qnt_qsnr: float                                            │   │
│  │  + golden_valid: bool                                               │   │
│  │  + status: str                                                      │   │
│  │  ─────────────────────────────────────────────────────────────────  │   │
│  │  + is_pass() -> bool                                                │   │
│  │  + is_golden_valid() -> bool                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 比对引擎设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          比对引擎类图                                        │
│                                                                             │
│                    ┌─────────────────────────────┐                          │
│                    │     <<interface>>           │                          │
│                    │      Comparator             │                          │
│                    │  ───────────────────────    │                          │
│                    │  + compare(a, b) -> Result  │                          │
│                    └──────────────┬──────────────┘                          │
│                                   │                                         │
│              ┌────────────────────┼────────────────────┐                    │
│              │                    │                    │                    │
│              ▼                    ▼                    ▼                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │ ExactComparator │  │ FuzzyComparator │  │SanityChecker    │             │
│  │ ─────────────── │  │ ─────────────── │  │ ─────────────── │             │
│  │ + atol: float   │  │ + atol: float   │  │ + min_qsnr: float│             │
│  │ ─────────────── │  │ + rtol: float   │  │ ─────────────── │             │
│  │ + compare()     │  │ + min_qsnr      │  │ + check()       │             │
│  └─────────────────┘  │ + min_cosine    │  └─────────────────┘             │
│                       │ ─────────────── │                                   │
│                       │ + compare()     │                                   │
│                       │ + compute_qsnr()│                                   │
│                       │ + compute_cos() │                                   │
│                       └─────────────────┘                                   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        CompareEngine                                 │   │
│  │  ─────────────────────────────────────────────────────────────────  │   │
│  │  + exact_comparator: ExactComparator                                │   │
│  │  + fuzzy_comparator: FuzzyComparator                                │   │
│  │  + sanity_checker: SanityChecker                                    │   │
│  │  ─────────────────────────────────────────────────────────────────  │   │
│  │  + compare_full(dut, golden_pure, golden_qnt) -> CompareResult      │   │
│  │  + determine_status(exact, fuzzy_pure, fuzzy_qnt, sanity) -> str    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 状态判定逻辑

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          状态判定矩阵                                        │
│                                                                             │
│  ┌───────────────┬───────────────┬─────────────────────────────────────┐   │
│  │ DUT vs Golden │ Golden 自检   │  判定状态                            │   │
│  │ (Exact/Fuzzy) │ (Sanity)      │                                     │   │
│  ├───────────────┼───────────────┼─────────────────────────────────────┤   │
│  │     PASS      │     PASS      │  PASS                               │   │
│  │               │               │  一切正常                            │   │
│  ├───────────────┼───────────────┼─────────────────────────────────────┤   │
│  │     PASS      │     FAIL      │  GOLDEN_SUSPECT                     │   │
│  │               │               │  DUT 结果正确但 Golden 可疑          │   │
│  ├───────────────┼───────────────┼─────────────────────────────────────┤   │
│  │     FAIL      │     PASS      │  DUT_ISSUE                          │   │
│  │               │               │  Golden 正常，DUT 有问题             │   │
│  ├───────────────┼───────────────┼─────────────────────────────────────┤   │
│  │     FAIL      │     FAIL      │  BOTH_SUSPECT                       │   │
│  │               │               │  都可疑，需人工排查                  │   │
│  └───────────────┴───────────────┴─────────────────────────────────────┘   │
│                                                                             │
│  Golden 自检项目:                                                           │
│  ─────────────────────────────────────────────────────────────────────────  │
│  1. 数值非全零/全一                                                         │
│  2. 无 NaN/Inf                                                              │
│  3. 数值范围合理                                                            │
│  4. Golden_qnt vs Golden_pure 的 QSNR >= 阈值                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 进程视图 (Process View)

### 4.1 编译流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          编译流程活动图                                       │
│                                                                             │
│                            ┌───────┐                                        │
│                            │ Start │                                        │
│                            └───┬───┘                                        │
│                                │                                            │
│                                ▼                                            │
│                       ┌───────────────┐                                     │
│                       │ 检查工具链版本 │                                     │
│                       └───────┬───────┘                                     │
│                               │                                             │
│               ┌───────────────┴───────────────┐                             │
│               │                               │                             │
│               ▼                               ▼                             │
│        ┌─────────────┐                 ┌─────────────┐                      │
│        │ 工具链存在   │                 │ 工具链缺失   │                      │
│        └──────┬──────┘                 └──────┬──────┘                      │
│               │                               │                             │
│               │                               ▼                             │
│               │                        ┌─────────────┐                      │
│               │                        │ 下载工具链   │                      │
│               │                        └──────┬──────┘                      │
│               │                               │                             │
│               └───────────────┬───────────────┘                             │
│                               │                                             │
│                               ▼                                             │
│                      ┌────────────────┐                                     │
│                      │ 判断前端类型    │                                     │
│                      └───────┬────────┘                                     │
│                              │                                              │
│              ┌───────────────┴───────────────┐                              │
│              │                               │                              │
│              ▼                               ▼                              │
│       ┌─────────────┐                 ┌─────────────┐                       │
│       │  Python     │                 │     C       │                       │
│       └──────┬──────┘                 └──────┬──────┘                       │
│              │                               │                              │
│              ▼                               │                              │
│       ┌─────────────┐                        │                              │
│       │ py2c 转换   │                        │                              │
│       │ + 生成Golden│                        │                              │
│       └──────┬──────┘                        │                              │
│              │                               │                              │
│              │  model_gen.c                  │  model.c                     │
│              │                               │                              │
│              └───────────────┬───────────────┘                              │
│                              │                                              │
│                              ▼                                              │
│                       ┌─────────────┐                                       │
│                       │ c2dut 编译  │                                       │
│                       └──────┬──────┘                                       │
│                              │                                              │
│                              ▼                                              │
│                       ┌─────────────┐                                       │
│                       │ model.bin   │                                       │
│                       └──────┬──────┘                                       │
│                              │                                              │
│                              ▼                                              │
│                          ┌───────┐                                          │
│                          │  End  │                                          │
│                          └───────┘                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 仿真比对流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        仿真比对流程活动图                                     │
│                                                                             │
│                            ┌───────┐                                        │
│                            │ Start │                                        │
│                            └───┬───┘                                        │
│                                │                                            │
│                                ▼                                            │
│                       ┌───────────────┐                                     │
│                       │ 加载 DUT 二进制│                                     │
│                       └───────┬───────┘                                     │
│                               │                                             │
│                               ▼                                             │
│                       ┌───────────────┐                                     │
│                       │ 加载 Golden   │                                     │
│                       └───────┬───────┘                                     │
│                               │                                             │
│                               ▼                                             │
│                       ┌───────────────┐                                     │
│                       │ 设置 GC Level │                                     │
│                       └───────┬───────┘                                     │
│                               │                                             │
│               ┌───────────────┼───────────────┐                             │
│               │               │               │                             │
│               ▼               ▼               ▼                             │
│        ┌───────────┐   ┌───────────┐   ┌───────────┐                       │
│        │  Level 1  │   │  Level 2  │   │  Level 3  │                       │
│        │   单步    │   │   片段    │   │  全模型   │                       │
│        └─────┬─────┘   └─────┬─────┘   └─────┬─────┘                       │
│              │               │               │                              │
│              ▼               ▼               ▼                              │
│        ┌───────────┐   ┌───────────┐   ┌───────────┐                       │
│        │每指令比对 │   │检查点比对 │   │最终输出比对│                       │
│        └─────┬─────┘   └─────┬─────┘   └─────┬─────┘                       │
│              │               │               │                              │
│              └───────────────┼───────────────┘                              │
│                              │                                              │
│                              ▼                                              │
│                    ┌─────────────────┐                                      │
│                    │    并行执行      │                                      │
│                    │ ┌─────────────┐ │                                      │
│                    │ │ Exact 比对  │ │                                      │
│                    │ └─────────────┘ │                                      │
│                    │ ┌─────────────┐ │                                      │
│                    │ │ Fuzzy Pure  │ │                                      │
│                    │ └─────────────┘ │                                      │
│                    │ ┌─────────────┐ │                                      │
│                    │ │ Fuzzy Qnt   │ │                                      │
│                    │ └─────────────┘ │                                      │
│                    │ ┌─────────────┐ │                                      │
│                    │ │ Golden 自检 │ │                                      │
│                    │ └─────────────┘ │                                      │
│                    └────────┬────────┘                                      │
│                             │                                               │
│                             ▼                                               │
│                    ┌─────────────────┐                                      │
│                    │    综合判定      │                                      │
│                    └────────┬────────┘                                      │
│                             │                                               │
│                             ▼                                               │
│                    ┌─────────────────┐                                      │
│                    │   生成报告       │                                      │
│                    └────────┬────────┘                                      │
│                             │                                               │
│                             ▼                                               │
│                         ┌───────┐                                           │
│                         │  End  │                                           │
│                         └───────┘                                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 三级比对时机

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         三级比对时机                                         │
│                                                                             │
│  Level 1: 单步 (Step)                                                       │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  ┌────┐   ┌────┐   ┌────┐   ┌────┐   ┌────┐   ┌────┐                      │
│  │Inst│ → │ GC │ → │Inst│ → │ GC │ → │Inst│ → │ GC │ → ...                │
│  │ 1  │   │比对│   │ 2  │   │比对│   │ 3  │   │比对│                      │
│  └────┘   └────┘   └────┘   └────┘   └────┘   └────┘                      │
│                                                                             │
│  触发: 每条指令执行后                                                        │
│  用途: 精确定位问题                                                          │
│  开销: 高                                                                   │
│                                                                             │
│  Level 2: 片段 (Segment)                                                    │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  ┌─────────────────────┐       ┌─────────────────────┐                     │
│  │    Segment 1        │       │    Segment 2        │                     │
│  │  ┌────┬────┬────┐   │       │  ┌────┬────┬────┐   │                     │
│  │  │Inst│Inst│Inst│   │       │  │Inst│Inst│Inst│   │                     │
│  │  └────┴────┴────┘   │       │  └────┴────┴────┘   │                     │
│  └──────────┬──────────┘       └──────────┬──────────┘                     │
│             │                             │                                 │
│             ▼                             ▼                                 │
│         ┌──────┐                      ┌──────┐                              │
│         │ GC   │                      │ GC   │                              │
│         │ 比对 │                      │ 比对 │                              │
│         └──────┘                      └──────┘                              │
│                                                                             │
│  触发: 算子边界/检查点                                                       │
│  用途: 日常验证                                                              │
│  开销: 中                                                                   │
│                                                                             │
│  Level 3: 全模型 (Full)                                                     │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        完整模型执行                                   │   │
│  │  ┌────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┐     │   │
│  │  │Inst│Inst│Inst│Inst│Inst│Inst│Inst│Inst│Inst│Inst│Inst│Inst│     │   │
│  │  └────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┘     │   │
│  └──────────────────────────────────────────┬──────────────────────────┘   │
│                                             │                               │
│                                             ▼                               │
│                                         ┌──────┐                            │
│                                         │ GC   │                            │
│                                         │ 比对 │                            │
│                                         └──────┘                            │
│                                                                             │
│  触发: 模型执行完毕                                                          │
│  用途: 回归测试                                                              │
│  开销: 低                                                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 开发视图 (Development View)

### 5.1 模块结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          模块结构图                                          │
│                                                                             │
│  aidevtools/                                                                │
│  │                                                                          │
│  ├── core/                         # 核心基础设施                           │
│  │   ├── __init__.py                                                        │
│  │   ├── config.py                 # 全局配置                               │
│  │   ├── constants.py              # 常量定义                               │
│  │   └── utils.py                  # 工具函数                               │
│  │                                                                          │
│  ├── ops/                          # 算子库                                 │
│  │   ├── __init__.py                                                        │
│  │   ├── base.py                   # 算子基类                               │
│  │   ├── functional.py             # 算子实现                               │
│  │   └── registry.py               # 算子注册表                             │
│  │                                                                          │
│  ├── formats/                      # 数据格式                               │
│  │   ├── __init__.py                                                        │
│  │   ├── quantize.py               # 量化接口                               │
│  │   └── custom/                   # 自定义格式                             │
│  │       ├── bfp/                  # BFP 格式                               │
│  │       └── gfloat/               # GFloat 格式                            │
│  │                                                                          │
│  ├── compare/                      # 比对引擎                               │
│  │   ├── __init__.py                                                        │
│  │   ├── engine.py                 # 比对引擎                               │
│  │   ├── exact.py                  # 精确比对                               │
│  │   ├── fuzzy.py                  # 模糊比对                               │
│  │   ├── sanity.py                 # Golden 自检                            │
│  │   └── report.py                 # 报告生成                               │
│  │                                                                          │
│  ├── toolchain/                    # 工具链管理                             │
│  │   ├── __init__.py                                                        │
│  │   ├── manager.py                # 管理器                                 │
│  │   ├── config.py                 # 配置加载                               │
│  │   └── download.py               # 下载器                                 │
│  │                                                                          │
│  ├── frontend/                     # 前端接口 (待实现)                      │
│  │   ├── __init__.py                                                        │
│  │   ├── unified.py                # 统一 API                               │
│  │   ├── compile.py                # 编译封装                               │
│  │   ├── trace.py                  # Trace 机制                             │
│  │   └── c/                        # C 头文件                               │
│  │       ├── types.h                                                        │
│  │       ├── ops.h                                                          │
│  │       └── data_gen.h                                                     │
│  │                                                                          │
│  └── cli.py                        # 命令行入口                             │
│                                                                             │
│  tests/                                                                     │
│  ├── ut/                           # 单元测试                               │
│  ├── it/                           # 集成测试                               │
│  └── st/                           # 系统测试                               │
│                                                                             │
│  docs/                                                                      │
│  └── design/                       # 设计文档                               │
│      └── gc_compare_architecture.md                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 模块依赖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          模块依赖图                                          │
│                                                                             │
│                         ┌─────────────┐                                     │
│                         │    cli      │                                     │
│                         └──────┬──────┘                                     │
│                                │                                            │
│                                ▼                                            │
│                         ┌─────────────┐                                     │
│                         │  frontend   │                                     │
│                         └──────┬──────┘                                     │
│                                │                                            │
│         ┌──────────────────────┼──────────────────────┐                     │
│         │                      │                      │                     │
│         ▼                      ▼                      ▼                     │
│  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐               │
│  │    ops      │       │   compare   │       │  toolchain  │               │
│  └──────┬──────┘       └──────┬──────┘       └──────┬──────┘               │
│         │                     │                     │                       │
│         │                     │                     │                       │
│         └──────────┬──────────┘                     │                       │
│                    │                                │                       │
│                    ▼                                │                       │
│             ┌─────────────┐                         │                       │
│             │   formats   │                         │                       │
│             └──────┬──────┘                         │                       │
│                    │                                │                       │
│                    └──────────────┬─────────────────┘                       │
│                                   │                                         │
│                                   ▼                                         │
│                            ┌─────────────┐                                  │
│                            │    core     │                                  │
│                            └─────────────┘                                  │
│                                                                             │
│  依赖方向: 上层依赖下层，禁止反向依赖                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 外部依赖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          外部依赖                                            │
│                                                                             │
│  必需依赖:                                                                   │
│  ─────────────────────────────────────────────────────────────────────────  │
│  numpy >= 1.21        数组计算                                              │
│  pyyaml >= 6.0        配置文件解析                                          │
│                                                                             │
│  可选依赖:                                                                   │
│  ─────────────────────────────────────────────────────────────────────────  │
│  httpx >= 0.24        工具链下载 (toolchain)                                │
│  torch >= 2.0         PyTorch 集成 (torch)                                  │
│  openpyxl >= 3.0      Excel 支持 (xlsx)                                     │
│                                                                             │
│  外部工具 (二进制):                                                          │
│  ─────────────────────────────────────────────────────────────────────────  │
│  py2c                 Python → C 转换器                                     │
│  c2dut                C → DUT 编译器                                        │
│  func-sim             功能仿真器                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 物理视图 (Physical View)

### 6.1 部署架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          部署架构                                            │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        开发者工作站                                    │ │
│  │                                                                       │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │                     Python 环境                                  │ │ │
│  │  │                                                                 │ │ │
│  │  │   aidevtools (pip install)                                      │ │ │
│  │  │   └── 依赖: numpy, pyyaml, httpx, ...                          │ │ │
│  │  │                                                                 │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                       │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │                     工具链缓存                                   │ │ │
│  │  │                                                                 │ │ │
│  │  │   ~/.cache/aidevtools/toolchain/                                │ │ │
│  │  │   ├── downloads/           # 下载缓存                           │ │ │
│  │  │   │   ├── py2c-1.0.0-*.tar.gz                                  │ │ │
│  │  │   │   └── c2dut-1.0.0-*.tar.gz                                 │ │ │
│  │  │   └── installed/           # 已安装                             │ │ │
│  │  │       ├── py2c-1.0.0-*/bin/py2c                                │ │ │
│  │  │       └── c2dut-1.0.0-*/bin/c2dut                              │ │ │
│  │  │                                                                 │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                       │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │                     项目目录                                     │ │ │
│  │  │                                                                 │ │ │
│  │  │   my_model/                                                     │ │ │
│  │  │   ├── python/model.py       # Python 前端                       │ │ │
│  │  │   ├── c/model.c             # C 前端                            │ │ │
│  │  │   ├── build/model.bin       # DUT 二进制                        │ │ │
│  │  │   ├── golden/               # Golden 数据                       │ │ │
│  │  │   └── reports/              # 比对报告                          │ │ │
│  │  │                                                                 │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                    │                                        │
│                                    │ 下载                                   │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        工具链注册中心                                  │ │
│  │                                                                       │ │
│  │   https://registry.company.com/toolchain/                             │ │
│  │   ├── py2c-1.0.0-linux-x64.tar.gz                                    │ │
│  │   ├── py2c-1.0.0-darwin-arm64.tar.gz                                 │ │
│  │   ├── c2dut-1.0.0-linux-x64.tar.gz                                   │ │
│  │   └── ...                                                             │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 数据流向

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          数据流向图                                          │
│                                                                             │
│  ┌─────────────┐                                                           │
│  │ model.py    │                                                           │
│  │ 或 model.c  │                                                           │
│  └──────┬──────┘                                                           │
│         │                                                                   │
│         │ 源代码                                                            │
│         ▼                                                                   │
│  ┌─────────────┐        ┌─────────────┐                                    │
│  │   py2c      │ ─────→ │ model_gen.c │                                    │
│  │             │        │ (中间产物)  │                                    │
│  └──────┬──────┘        └──────┬──────┘                                    │
│         │                      │                                            │
│         │ Golden 数据           │ C 代码                                    │
│         ▼                      ▼                                            │
│  ┌─────────────┐        ┌─────────────┐                                    │
│  │  golden/    │        │   c2dut     │                                    │
│  │  ├─ inputs/ │        └──────┬──────┘                                    │
│  │  ├─ weights/│               │                                           │
│  │  └─ outputs/│               │ DUT 二进制                                 │
│  └──────┬──────┘               ▼                                           │
│         │               ┌─────────────┐                                    │
│         │               │ model.bin   │                                    │
│         │               └──────┬──────┘                                    │
│         │                      │                                            │
│         │                      │                                            │
│         └──────────┬───────────┘                                           │
│                    │                                                        │
│                    ▼                                                        │
│             ┌─────────────┐                                                 │
│             │  func-sim   │                                                 │
│             │  (仿真器)   │                                                 │
│             └──────┬──────┘                                                 │
│                    │                                                        │
│                    │ 比对结果                                               │
│                    ▼                                                        │
│             ┌─────────────┐                                                 │
│             │  reports/   │                                                 │
│             │  ├─ summary │                                                 │
│             │  └─ details │                                                 │
│             └─────────────┘                                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 数据设计

### 7.1 Golden 数据格式

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Golden 数据目录结构                                    │
│                                                                             │
│  golden/                                                                    │
│  │                                                                          │
│  ├── manifest.json              # 元信息清单                                │
│  │   {                                                                      │
│  │     "version": "1.0",                                                    │
│  │     "model": "mini_transformer",                                         │
│  │     "seed": 42,                                                          │
│  │     "dtype": "bfp16",                                                    │
│  │     "checkpoints": ["after_qkv", "after_attn"]                           │
│  │   }                                                                      │
│  │                                                                          │
│  ├── inputs/                    # 输入数据                                  │
│  │   ├── x.npy                  # fp32 数据                                 │
│  │   ├── x.bin                  # 量化数据                                  │
│  │   └── x.meta.json            # 元信息 (shape, dtype, qtype)             │
│  │                                                                          │
│  ├── weights/                   # 权重数据                                  │
│  │   ├── w_q.npy                                                            │
│  │   ├── w_q.bin                                                            │
│  │   ├── w_q.meta.json                                                      │
│  │   └── ...                                                                │
│  │                                                                          │
│  ├── intermediates/             # 中间结果 (用于片段比对)                    │
│  │   ├── after_qkv/                                                         │
│  │   │   ├── q.npy                                                          │
│  │   │   ├── k.npy                                                          │
│  │   │   └── v.npy                                                          │
│  │   └── after_attn/                                                        │
│  │       └── out.npy                                                        │
│  │                                                                          │
│  └── outputs/                   # 最终输出                                  │
│      ├── y_pure.npy             # 纯 fp32 计算结果                          │
│      └── y_qnt.npy              # 量化感知计算结果                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 比对报告格式

```json
{
  "version": "1.0",
  "timestamp": "2024-01-15T10:30:00Z",
  "model": "mini_transformer",
  "gc_level": 2,

  "summary": {
    "total_checkpoints": 3,
    "total_tensors": 8,
    "status_counts": {
      "PASS": 7,
      "GOLDEN_SUSPECT": 1,
      "DUT_ISSUE": 0,
      "BOTH_SUSPECT": 0
    },
    "golden_valid_rate": 0.875,
    "dut_pass_rate": 1.0
  },

  "checkpoints": [
    {
      "name": "after_qkv_proj",
      "tensors": [
        {
          "name": "q",
          "shape": [2, 64],
          "dtype": "bfp16",
          "exact": {
            "pass": true,
            "max_abs": 0.0,
            "mismatch_count": 0
          },
          "fuzzy_pure": {
            "pass": true,
            "qsnr": 65.2,
            "cosine": 0.999999,
            "max_abs": 1.2e-5
          },
          "fuzzy_qnt": {
            "pass": true,
            "qsnr": 42.1,
            "cosine": 0.999812,
            "max_abs": 3.1e-3
          },
          "golden_sanity": {
            "pass": true,
            "has_nan": false,
            "has_inf": false,
            "all_zero": false,
            "qnt_vs_pure_qsnr": 38.5
          },
          "status": "PASS"
        }
      ]
    }
  ]
}
```

### 7.3 配置文件格式

```yaml
# toolchain.yaml

registry:
  url: "https://registry.company.com/toolchain"
  proxy: "${HTTP_PROXY}"
  auth:
    type: bearer
    token: "${TOOLCHAIN_TOKEN}"
  timeout: 60
  retries: 3

versions:
  py2c: "1.0.0"
  c2dut: "1.0.0"

files:
  "py2c-1.0.0-linux-x64.tar.gz": "sha256:abc123..."
  "py2c-1.0.0-darwin-arm64.tar.gz": "sha256:def456..."
  "c2dut-1.0.0-linux-x64.tar.gz": "sha256:ghi789..."
  "c2dut-1.0.0-darwin-arm64.tar.gz": "sha256:jkl012..."

# compare.yaml (比对配置)

exact:
  atol: 0.0
  max_mismatch: 0

fuzzy:
  atol: 1e-5
  rtol: 1e-3
  min_qsnr: 30.0
  min_cosine: 0.99

sanity:
  min_qsnr_qnt_vs_pure: 20.0
  allow_all_zero: false

gc:
  level: 2  # 1=step, 2=segment, 3=full
  checkpoints:
    - "after_qkv_proj"
    - "after_attention"
    - "after_ffn"
```

---

## 8. 接口设计

### 8.1 Python API

```python
# 统一前端 API

from aidevtools.frontend import (
    Tensor,
    DataGenerator,
    OpContext,
    matmul,
    layernorm,
    softmax,
    compile_to_dut,
)

# 数据生成
gen = DataGenerator(seed=42)
x = gen.gen_input(shape=(2, 64), dtype="bfp16", dist="normal")
w = gen.gen_weight(shape=(64, 64), dtype="bfp16", init="xavier")

# 算子调用
ctx = OpContext(dtype="bfp16")
y = Tensor.empty(shape=(2, 64), dtype="bfp16")
matmul(x, w, y, ctx=ctx)

# 编译
compile_to_dut(
    "model.py",
    output="build/model.bin",
    golden_dir="golden/",
)
```

### 8.2 C API

```c
// types.h

typedef enum {
    DTYPE_FP32 = 0,
    DTYPE_BFP16 = 1,
    DTYPE_BFP8 = 2,
} DataType;

typedef struct {
    void* data;
    void* quant_data;
    size_t shape[8];
    size_t ndim;
    DataType dtype;
} TensorDesc;

typedef struct {
    DataType default_dtype;
    int enable_gc;
    int gc_level;
} OpContext;

// ops.h

void matmul(
    const TensorDesc* a,
    const TensorDesc* b,
    TensorDesc* c,
    bool trans_a,
    bool trans_b,
    const OpContext* ctx
);

void layernorm(
    const TensorDesc* x,
    const TensorDesc* gamma,
    const TensorDesc* beta,
    TensorDesc* y,
    float eps,
    const OpContext* ctx
);

// data_gen.h

void gen_input(
    DataGenContext* ctx,
    TensorDesc* out,
    const size_t* shape,
    size_t ndim,
    DataType dtype,
    DistType dist
);
```

### 8.3 CLI 接口

```bash
# 工具链管理
aidevtools toolchain install          # 安装工具链
aidevtools toolchain list             # 列出已安装
aidevtools toolchain clean            # 清理缓存

# 编译
aidevtools compile model.py -o build/model.bin --golden golden/
aidevtools compile model.c -o build/model.bin

# 仿真比对
aidevtools sim build/model.bin --golden golden/ --gc-level 2

# 报告
aidevtools report reports/ --format html
```

---

## 9. 附录

### 9.1 比对指标定义

| 指标 | 公式 | 说明 |
|------|------|------|
| max_abs | max(\|a - b\|) | 最大绝对误差 |
| mean_abs | mean(\|a - b\|) | 平均绝对误差 |
| QSNR | 10 * log10(Σa² / Σ(a-b)²) | 量化信噪比 (dB) |
| Cosine | (a·b) / (\|a\| * \|b\|) | 余弦相似度 |

### 9.2 状态码定义

| 状态 | 含义 | 建议行动 |
|------|------|----------|
| PASS | 一切正常 | 无 |
| GOLDEN_SUSPECT | Golden 可疑 | 检查 Golden 生成逻辑 |
| DUT_ISSUE | DUT 有问题 | 检查 DUT 实现 |
| BOTH_SUSPECT | 都可疑 | 人工排查 |

### 9.3 参考文档

- [aidevtools README](../README.md)
- [比对工具指南](./tools/compare.md)
- [量化格式说明](./tools/formats.md)

---

*文档结束*
