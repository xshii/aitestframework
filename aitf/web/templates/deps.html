{% extends "base.html" %}
{% block title %}Dependencies{% endblock %}
{% block content %}
<h4>Dependencies</h4>

{% if not has_config %}
<div class="alert alert-warning">deps.yaml not found or invalid. Place a valid deps.yaml in the project root.</div>
{% endif %}

{% if deps %}
<table class="table table-striped table-sm">
  <thead><tr><th>Name</th><th>Type</th><th>Version / Ref</th></tr></thead>
  <tbody>
  {% for d in deps %}
  <tr>
    <td>{{ d.name }}</td>
    <td><span class="badge bg-{{ 'primary' if d.type == 'toolchain' else ('info' if d.type == 'library' else 'secondary') }}">{{ d.type }}</span></td>
    <td><code>{{ d.version }}</code></td>
  </tr>
  {% endfor %}
  </tbody>
</table>
{% endif %}

<hr>
<h5>Uploaded Archives <small class="text-muted">(deps/uploads/)</small></h5>

<form id="uploadForm" class="mb-3">
  <div class="input-group" style="max-width:500px">
    <input type="file" id="uploadFile" accept=".tar.gz,.gz" class="form-control form-control-sm" required>
    <button type="submit" class="btn btn-sm btn-primary">Upload</button>
  </div>
  <small class="text-muted">Upload a .tar.gz archive (e.g. npu-compiler-2.1.0-linux-x86_64.tar.gz)</small>
  <div id="uploadMsg" class="small mt-1"></div>
</form>

{% if uploads %}
<table class="table table-striped table-sm">
  <thead><tr><th>Filename</th><th>Size</th><th></th></tr></thead>
  <tbody>
  {% for u in uploads %}
  <tr>
    <td><code>{{ u.name }}</code></td>
    <td>{{ u.size }}</td>
    <td>
      <a href="/api/deps/uploads/{{ u.name }}/download" class="btn btn-sm btn-outline-primary">Download</a>
      <button class="btn btn-sm btn-outline-danger btn-delete-dep" data-name="{{ u.name }}">Delete</button>
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>
{% else %}
<p class="text-muted">No archives uploaded yet.</p>
{% endif %}

<script>
document.getElementById('uploadForm').addEventListener('submit', function(e) {
  e.preventDefault();
  var file = document.getElementById('uploadFile').files[0];
  if (!file) return;
  var fd = new FormData();
  fd.append('file', file);
  var msg = document.getElementById('uploadMsg');
  msg.textContent = 'Uploading...';
  fetch('/api/deps/upload', {method: 'POST', body: fd})
    .then(r => r.json())
    .then(d => {
      if (d.error) { msg.textContent = 'Error: ' + d.error; }
      else { location.reload(); }
    }).catch(e => { msg.textContent = 'Failed: ' + e; });
});

document.querySelectorAll('.btn-delete-dep').forEach(function(btn) {
  btn.addEventListener('click', function() {
    var name = this.dataset.name;
    if (!confirm('Delete "' + name + '"?')) return;
    fetch('/api/deps/uploads/' + encodeURIComponent(name), {method: 'DELETE'})
      .then(r => r.json())
      .then(d => {
        if (d.error) alert('Error: ' + d.error);
        else location.reload();
      }).catch(e => alert('Failed: ' + e));
  });
});
</script>
{% endblock %}
