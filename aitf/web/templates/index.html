{% extends "base.html" %}
{% block title %}aitestframework{% endblock %}
{% block content %}

<ul class="nav nav-tabs" id="mainTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="deps-tab" data-bs-toggle="tab" data-bs-target="#tab-deps" type="button" role="tab">Deps</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="bundles-tab" data-bs-toggle="tab" data-bs-target="#tab-bundles" type="button" role="tab">Bundles</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#tab-logs" type="button" role="tab">Logs</button>
  </li>
</ul>

<div class="tab-content pt-3" id="mainTabContent">

{# ===== DEPS TAB ===== #}
<div class="tab-pane fade show active" id="tab-deps" role="tabpanel">
<h4>Dependencies</h4>

{% if not has_config %}
<div class="alert alert-warning">deps.yaml not found or invalid. Place a valid deps.yaml in the project root.</div>
{% endif %}

{% if deps %}
<table class="table table-striped table-sm">
  <thead><tr><th>Name</th><th>Type</th><th>Version / Ref</th></tr></thead>
  <tbody>
  {% for d in deps %}
  <tr>
    <td>{{ d.name }}</td>
    <td><span class="badge bg-{{ 'primary' if d.type == 'toolchain' else ('info' if d.type == 'library' else 'secondary') }}">{{ d.type }}</span></td>
    <td><code>{{ d.version }}</code></td>
  </tr>
  {% endfor %}
  </tbody>
</table>
{% endif %}

<hr>
<h5>Uploaded Archives <small class="text-muted">(deps/uploads/)</small></h5>

<form id="uploadForm" class="mb-3">
  <div class="input-group" style="max-width:500px">
    <input type="file" id="uploadFile" accept=".tar.gz,.gz" class="form-control form-control-sm" required>
    <button type="submit" class="btn btn-sm btn-primary">Upload</button>
  </div>
  <small class="text-muted">Upload a .tar.gz archive (e.g. npu-compiler-2.1.0-linux-x86_64.tar.gz)</small>
  <div id="uploadMsg" class="small mt-1"></div>
</form>

{% if uploads %}
<table class="table table-striped table-sm">
  <thead><tr><th>Filename</th><th>Size</th><th></th></tr></thead>
  <tbody>
  {% for u in uploads %}
  <tr>
    <td><code>{{ u.name }}</code></td>
    <td>{{ u.size }}</td>
    <td>
      <a href="/api/deps/uploads/{{ u.name }}/download" class="btn btn-sm btn-outline-primary">Download</a>
      <button class="btn btn-sm btn-outline-danger btn-delete-dep" data-name="{{ u.name }}">Delete</button>
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>
{% else %}
<p class="text-muted">No archives uploaded yet.</p>
{% endif %}
</div>

{# ===== BUNDLES TAB ===== #}
<div class="tab-pane fade" id="tab-bundles" role="tabpanel">
<h4>Bundles</h4>

{% if bundles %}
<table class="table table-striped table-sm">
  <thead><tr><th>Name</th><th>Description</th><th>Status</th><th>Toolchains</th><th>Libraries</th><th>Repos</th><th></th></tr></thead>
  <tbody>
  {% for b in bundles %}
  <tr class="{% if b.name == active_name %}table-success{% endif %}">
    <td>
      <strong>{{ b.name }}</strong>
      {% if b.name == active_name %}<span class="badge bg-success">active</span>{% endif %}
    </td>
    <td>{{ b.description }}</td>
    <td>
      <span class="badge bg-{{ 'success' if b.status == 'verified' else ('warning' if b.status == 'testing' else 'danger') }}">{{ b.status }}</span>
    </td>
    <td>{% for k, v in b.toolchains.items() %}<code>{{ k }}:{{ v }}</code> {% endfor %}</td>
    <td>{% for k, v in b.libraries.items() %}<code>{{ k }}:{{ v }}</code> {% endfor %}</td>
    <td>{% for k, v in b.repos.items() %}<code>{{ k }}:{{ v }}</code> {% endfor %}</td>
    <td class="text-nowrap">
      <a href="/api/bundles/{{ b.name }}/export" class="btn btn-sm btn-outline-primary">Export</a>
      <button class="btn btn-sm btn-outline-danger btn-delete-bundle" data-name="{{ b.name }}">Delete</button>
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>
{% else %}
<p class="text-muted">No bundles configured.</p>
{% endif %}

<hr>
<div class="row">
<div class="col-md-6">
<h5>Create Bundle</h5>
<form id="createBundleForm">
  <div class="mb-2">
    <label class="form-label form-label-sm">Name</label>
    <input type="text" id="bundleName" class="form-control form-control-sm" required placeholder="e.g. npu-v2.2">
  </div>
  <div class="mb-2">
    <label class="form-label form-label-sm">Description</label>
    <input type="text" id="bundleDesc" class="form-control form-control-sm" placeholder="Optional description">
  </div>
  <div class="mb-2">
    <label class="form-label form-label-sm">Status</label>
    <select id="bundleStatus" class="form-select form-select-sm">
      <option value="testing">testing</option>
      <option value="verified">verified</option>
      <option value="deprecated">deprecated</option>
    </select>
  </div>

  {% if available.toolchains %}
  <fieldset class="mb-2">
    <legend class="fs-6">Toolchains</legend>
    {% for name, ver in available.toolchains.items() %}
    <div class="input-group input-group-sm mb-1">
      <div class="input-group-text">
        <input type="checkbox" class="form-check-input mt-0" id="tc_check_{{ name }}" checked>
      </div>
      <span class="input-group-text">{{ name }}</span>
      <input type="text" id="tc_ver_{{ name }}" class="form-control" value="{{ ver }}" placeholder="version">
    </div>
    {% endfor %}
  </fieldset>
  {% endif %}

  {% if available.libraries %}
  <fieldset class="mb-2">
    <legend class="fs-6">Libraries</legend>
    {% for name, ver in available.libraries.items() %}
    <div class="input-group input-group-sm mb-1">
      <div class="input-group-text">
        <input type="checkbox" class="form-check-input mt-0" id="lib_check_{{ name }}" checked>
      </div>
      <span class="input-group-text">{{ name }}</span>
      <input type="text" id="lib_ver_{{ name }}" class="form-control" value="{{ ver }}" placeholder="version">
    </div>
    {% endfor %}
  </fieldset>
  {% endif %}

  {% if available.repos %}
  <fieldset class="mb-2">
    <legend class="fs-6">Repos</legend>
    {% for name, ref in available.repos.items() %}
    <div class="input-group input-group-sm mb-1">
      <div class="input-group-text">
        <input type="checkbox" class="form-check-input mt-0" id="repo_check_{{ name }}" checked>
      </div>
      <span class="input-group-text">{{ name }}</span>
      <input type="text" id="repo_ref_{{ name }}" class="form-control" value="{{ ref }}" placeholder="branch / tag / commit">
    </div>
    {% endfor %}
  </fieldset>
  {% endif %}

  <button type="submit" class="btn btn-sm btn-primary">Create</button>
</form>
</div>

<div class="col-md-6">
<h5>Import Bundle</h5>
<form id="importBundleForm">
  <div class="input-group input-group-sm" style="max-width:400px">
    <input type="file" id="importFile" accept=".tar.gz,.gz" class="form-control" required>
    <button type="submit" class="btn btn-primary">Import</button>
  </div>
  <small class="text-muted">Upload a bundle .tar.gz exported from another machine</small>
  <div id="importMsg" class="small mt-1"></div>
</form>
</div>
</div>
</div>

{# ===== LOGS TAB ===== #}
<div class="tab-pane fade" id="tab-logs" role="tabpanel">
<h4>Logs</h4>

{% if log_entries %}
<table class="table table-striped table-hover table-sm">
  <thead><tr><th>Name</th><th>Size</th><th></th></tr></thead>
  <tbody>
  {% for e in log_entries %}
  <tr>
    <td>
      {% if e.is_dir %}
        <a href="{{ url_for('logs.log_index', subpath=e.path) }}">{{ e.name }}/</a>
      {% else %}
        <a href="{{ url_for('logs.log_view', subpath=e.path) }}">{{ e.name }}</a>
      {% endif %}
    </td>
    <td>{% if not e.is_dir %}{{ e.size_display }}{% endif %}</td>
    <td>{% if not e.is_dir %}<a href="{{ url_for('logs.log_download', subpath=e.path) }}" class="btn btn-sm btn-outline-primary">Download</a>{% endif %}</td>
  </tr>
  {% endfor %}
  </tbody>
</table>
{% else %}
<p class="text-muted">No files found.</p>
{% endif %}
</div>

</div>{# /tab-content #}

<script>
/* Remember active tab via URL hash */
var hash = window.location.hash;
if (hash) {
  var tab = document.querySelector('[data-bs-target="' + hash + '"]');
  if (tab) new bootstrap.Tab(tab).show();
}
document.querySelectorAll('#mainTabs button').forEach(function(btn) {
  btn.addEventListener('shown.bs.tab', function() {
    history.replaceState(null, null, btn.dataset.bsTarget);
  });
});

/* Deps: upload */
document.getElementById('uploadForm').addEventListener('submit', function(e) {
  e.preventDefault();
  var file = document.getElementById('uploadFile').files[0];
  if (!file) return;
  var fd = new FormData();
  fd.append('file', file);
  var msg = document.getElementById('uploadMsg');
  msg.textContent = 'Uploading...';
  fetch('/api/deps/upload', {method: 'POST', body: fd})
    .then(r => r.json())
    .then(d => {
      if (d.error) { msg.textContent = 'Error: ' + d.error; }
      else { location.reload(); }
    }).catch(e => { msg.textContent = 'Failed: ' + e; });
});

/* Deps: delete upload */
document.querySelectorAll('.btn-delete-dep').forEach(function(btn) {
  btn.addEventListener('click', function() {
    var name = this.dataset.name;
    if (!confirm('Delete "' + name + '"?')) return;
    fetch('/api/deps/uploads/' + encodeURIComponent(name), {method: 'DELETE'})
      .then(r => r.json())
      .then(d => {
        if (d.error) alert('Error: ' + d.error);
        else location.reload();
      }).catch(e => alert('Failed: ' + e));
  });
});

/* Bundles: create */
document.getElementById('createBundleForm').addEventListener('submit', function(e) {
  e.preventDefault();
  var body = {
    name: document.getElementById('bundleName').value,
    description: document.getElementById('bundleDesc').value,
    status: document.getElementById('bundleStatus').value,
    toolchains: {}, libraries: {}, repos: {}
  };
  {% for name in available.toolchains %}
  if (document.getElementById('tc_check_{{ name }}').checked)
    body.toolchains['{{ name }}'] = document.getElementById('tc_ver_{{ name }}').value;
  {% endfor %}
  {% for name in available.libraries %}
  if (document.getElementById('lib_check_{{ name }}').checked)
    body.libraries['{{ name }}'] = document.getElementById('lib_ver_{{ name }}').value;
  {% endfor %}
  {% for name in available.repos %}
  if (document.getElementById('repo_check_{{ name }}').checked)
    body.repos['{{ name }}'] = document.getElementById('repo_ref_{{ name }}').value;
  {% endfor %}

  fetch('/api/bundles', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  }).then(r => r.json()).then(d => {
    if (d.error) alert('Error: ' + d.error);
    else { location.hash = '#tab-bundles'; location.reload(); }
  }).catch(e => alert('Failed: ' + e));
});

/* Bundles: import */
document.getElementById('importBundleForm').addEventListener('submit', function(e) {
  e.preventDefault();
  var file = document.getElementById('importFile').files[0];
  if (!file) return;
  var fd = new FormData();
  fd.append('file', file);
  var msg = document.getElementById('importMsg');
  msg.textContent = 'Importing...';
  fetch('/api/bundles/import', {method: 'POST', body: fd})
    .then(r => r.json())
    .then(d => {
      if (d.error) { msg.textContent = 'Error: ' + d.error; }
      else { location.hash = '#tab-bundles'; location.reload(); }
    }).catch(e => { msg.textContent = 'Failed: ' + e; });
});

/* Bundles: delete */
document.querySelectorAll('.btn-delete-bundle').forEach(function(btn) {
  btn.addEventListener('click', function() {
    var name = this.dataset.name;
    if (!confirm('Delete bundle "' + name + '"?')) return;
    fetch('/api/bundles/' + encodeURIComponent(name), {method: 'DELETE'})
      .then(r => r.json())
      .then(d => {
        if (d.error) alert('Error: ' + d.error);
        else { location.hash = '#tab-bundles'; location.reload(); }
      }).catch(e => alert('Failed: ' + e));
  });
});
</script>
{% endblock %}
